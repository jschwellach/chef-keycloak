# Conditional Client Calls can't be run as BATCH

# Add the datasource
<%- node['wildfly']['postgresql']['jndi']['datasources'].each do |source|  %>
if (outcome != success) of /subsystem=datasources/data-source=<%= source['pool_name'] %>:read-resource
  data-source add --name=<%= source['pool_name'] %> --driver-name=postgres --jndi-name=<%= source['jndi_name'] %> --connection-url=jdbc:postgresql://<%= source['server'] %>:<%= source['port'] %>/<%= source['db_name'] %> --user-name=<%= source['db_user'] %> --password=<%= source['db_pass'] %> --use-ccm=true --max-pool-size=<%= source['pool_max'] %> --blocking-timeout-wait-millis=5000 --enabled=true --driver-class=org.postgresql.Driver --exception-sorter-class-name=org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLExceptionSorter --jta=true --use-java-context=true --valid-connection-checker-class-name=org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLValidConnectionChecker
else
  /subsystem=datasources/data-source=<%= source['pool_name'] %>:remove
  data-source add --name=<%= source['pool_name'] %> --driver-name=postgres --jndi-name=<%= source['jndi_name'] %> --connection-url=jdbc:postgresql://<%= source['server'] %>:<%= source['port'] %>/<%= source['db_name'] %> --user-name=<%= source['db_user'] %> --password=<%= source['db_pass'] %> --use-ccm=true --max-pool-size=<%= source['pool_max'] %> --blocking-timeout-wait-millis=5000 --enabled=true --driver-class=org.postgresql.Driver --exception-sorter-class-name=org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLExceptionSorter --jta=true --use-java-context=true --valid-connection-checker-class-name=org.jboss.jca.adapters.jdbc.extensions.postgres.PostgreSQLValidConnectionChecker
end-if
<%- end %>
